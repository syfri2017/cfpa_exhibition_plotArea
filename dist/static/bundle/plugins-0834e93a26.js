!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Postmate=e()}(this,function(){"use strict";var t="undefined"!=typeof MessageChannel,e="application/x-postmate-v1+json",n=0,i={handshake:1,"handshake-reply":1,call:1,emit:1,reply:1,request:1},o=function(n,o){return!(!t&&"string"==typeof o&&n.origin!==o)&&"object"==typeof n.data&&"postmate"in n.data&&n.data.type===e&&!!i[n.data.postmate]},s=function(e,n,i){e.postMessage(n,t?void 0:i)},r=function(){function t(t){var e=this;this.parent=t.parent,this.frame=t.frame,this.child=t.child,this.childOrigin=t.childOrigin,this.source=t.source,this.events={},this.listener=function(t){if(o(t,e.childOrigin)&&"emit"===t.data.postmate){var n=t.data.value,i=n.data,s=n.name;s in e.events&&e.events[s].call(e,i)}},this.addMessageListener(this.listener)}var i=t.prototype;return i.addMessageListener=function(t){this.source.addEventListener("message",t,!1)},i.removeMessageListener=function(t){this.source.removeEventListener("message",t,!1)},i.get=function(t){var i=this;return new c.Promise(function(r){var a=++n;i.addMessageListener(function t(e){o(e,i.childOrigin)&&e.data.uid===a&&"reply"===e.data.postmate&&(i.removeMessageListener(t),r(e.data.value))}),s(i.source,{postmate:"request",type:e,property:t,uid:a},i.childOrigin)})},i.call=function(t,n){s(this.source,{postmate:"call",type:e,property:t,data:n},this.childOrigin)},i.on=function(t,e){this.events[t]=e},i.destroy=function(){this.removeMessageListener(this.listener),this.frame.parentNode.removeChild(this.frame)},t}(),a=function(){function t(t){var n=this;this.model=t.model,this.parent=t.parent,this.parentOrigin=t.parentOrigin,this.child=t.child,this.source=t.source,this.source.addEventListener("message",function(t){if(o(t,n.parentOrigin)){var i,r,a,d=t.data,u=d.property,h=d.uid,p=d.data;"call"!==t.data.postmate?(i=n.model,r=u,a="function"==typeof i[r]?i[r]():i[r],c.Promise.resolve(a)).then(function(t){return s(n.source,{property:u,postmate:"reply",type:e,uid:h,value:t},n.parentOrigin)}):u in n.model&&"function"==typeof n.model[u]&&n.model[u].call(n,p)}})}return t.prototype.emit=function(t,n){s(this.source,{postmate:"emit",type:e,value:{name:t,data:n}},this.parentOrigin)},t}(),c=function(){function n(t){var e=void 0===t?userOptions:t,n=e.container,i=void 0===n?void 0!==i?i:document.body:n,o=e.model,s=e.url;return this.parent=window,this.frame=document.createElement("iframe"),i.appendChild(this.frame),this.child=this.frame.contentWindow||this.frame.contentDocument.parentWindow,this.model=o||{},this.sendHandshake(s)}return n.prototype.sendHandshake=function(i){var s,a,c=this,d=function(t){var e=document.createElement("a");e.href=t;var n=4<e.protocol.length?e.protocol:window.location.protocol,i=e.host.length?"80"===e.port||"443"===e.port?e.hostname:e.host:window.location.host;return e.origin||n+"//"+i}(i),u=0;return new n.Promise(function(n,h){var p=function(t){var e=function(e){if(o(e,d))return c.source=t,"handshake-reply"===e.data.postmate?(clearInterval(s),i(),c.childOrigin=e.origin,n(new r(c))):h("Failed handshake")};t.addEventListener("message",e,!1);var i=function(){t.removeEventListener("message",e,!1)};return i},m=function(){if(5!==u){var n,i;if(u++,a&&a(),t){var o=new MessageChannel;n=o.port1,i=o.port2,a=p(n),n.start()}else a=p(c.parent);c.child.postMessage({postmate:"handshake",type:e,model:c.model},d,i?[i]:[])}else clearInterval(s)},f=function(){m(),s=setInterval(m,500)};c.frame.attachEvent?c.frame.attachEvent("onload",f):c.frame.onload=f,c.frame.src=i})},n}();return c.Promise=function(){try{return window?window.Promise:Promise}catch(t){return function(){var t;return c.debug?(t=console).log.apply(t,arguments):null}("Promise: error",t)}}(),c.Model=function(){function t(t){return this.child=window,this.model=t,this.parent=this.child.parent,this.sendHandshakeReply()}return t.prototype.sendHandshakeReply=function(){var t=this;return new c.Promise(function(n,i){t.child.addEventListener("message",function s(r){if(o(r,!1)){if("handshake"===r.data.postmate){t.child.removeEventListener("message",s,!1);var c=r.source,d=r.ports,u=r.origin,h={postmate:"handshake-reply",type:e};if(d){var p=d[0];p.postMessage(h),(t.source=p).start()}else c.postMessage(h,u),t.source=c;t.parentOrigin=u;var m=r.data.model;return m&&Object.keys(m).forEach(function(e){t.model[e]=m[e]}),n(new a(t))}return i("Handshake Reply Failed")}},!1)})},t}(),c}),function(){function t(t,e){var n,i;for(n in e)void 0!==(i=e[n])&&(t[n]=i);return t}var e=function(){},n=function(n,i){var o;return o=i&&i.hasOwnProperty("constructor")?i.constructor:function(){return n.apply(this,arguments)},e.prototype=n.prototype,o.prototype=new e,i&&t(o.prototype,i),o.prototype.constructor=o,o.__super__=n.prototype,o},i={version:"0.1.15"};i.Stack=function(){this.commands=[],this.stackPosition=-1,this.savePosition=-1},t(i.Stack.prototype,{execute:function(t){this._clearRedo(),t.execute(),this.commands.push(t),this.stackPosition++,this.changed()},undo:function(){this.commands[this.stackPosition].undo(),this.stackPosition--,this.changed()},canUndo:function(){return this.stackPosition>=0},redo:function(){this.stackPosition++,this.commands[this.stackPosition].redo(),this.changed()},canRedo:function(){return this.stackPosition<this.commands.length-1},save:function(){this.savePosition=this.stackPosition,this.changed()},dirty:function(){return this.stackPosition!=this.savePosition},_clearRedo:function(){this.commands=this.commands.slice(0,this.stackPosition+1)},changed:function(){}}),i.Command=function(t){this.name=t};var o=new Error("override me!");t(i.Command.prototype,{execute:function(){throw o},undo:function(){throw o},redo:function(){this.execute()}}),i.Command.extend=function(t){var e=n(this,t);return e.extend=i.Command.extend,e},"function"==typeof define&&define.amd?define(i):"undefined"!=typeof module&&module.exports?module.exports=i:this.Undo=i}.call(this);